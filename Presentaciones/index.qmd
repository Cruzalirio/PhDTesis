---
title: "Modelos geoestadísticos y procesos espaciales."
subtitle: "Modelo Espacial autoregresivo (SAR)" 
author: 
  - name: Nelson Alirio Cruz
    orcid: 0000-0002-7370-5111
    email: nelsonaliriocruz@gmail.com
    affiliations: 
      - name: "Universidad Nacional de Colombia"
        city: "Bogotá, Colombia"
        
format: 
  revealjs:
    theme: serif #dracula.scss
    fontsize: 2.0em
embed-resources: true
lang: ES
editor: visual
bibliography: references.bib
---

# Bloque 1: Clase para pregrado

## Introducción a la autocorrelación

Concepto: la autocorrelación refleja que valores cercanos espacial o temporalmente tienden a ser similares.

-   Temporal: precios de acciones, temperatura diaria,

-   Espacial: deforestación, crimen por vecindario.

```{r}
library(tidyverse)
library(spdep)
library(spatialreg)
library(gamlss)
library(sphet)
library(xtable)
library(readxl)
library(qqplotr)
library(latex2exp)
library(spatemR)
library(cowplot)
```

```{r, echo=TRUE}

DataCovariates <- read_excel("DataCovariates.xlsx")
gini <- read_excel("Distribution.xlsx")
DataTotal <-merge(gini, y=DataCovariates, 
                        by.x="CODMUNI", by.y="Divipola", all.x=TRUE, all.y = TRUE)

mapColombia <-read_sf("Shape/Municipios_desercion.shp", , options = "ENCODING=UTF8") # 380 units

DataTotal <- merge(x=mapColombia, y=DataTotal, 
                    by.x="mpio_cdpmp", by.y="CODMUNI", all.x=TRUE)
```

## Índice de Gini en Colombia

```{r}
p1 <- ggplot()+geom_sf(data=DataTotal, aes(fill = GINI))+
  coord_sf()

p1 <- p1 +ggspatial::annotation_scale(
  location = "tl",
  bar_cols = c("grey60", "white")
) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )+
  xlab("Longitude")+
  ylab("Latitude")+
  scale_fill_gradientn(colours = c("darkred", "orange",
                                   "yellow"),
                       name = "Gini index" ,na.value="white",
                       limits=c(0,1))
p2 <- ggplot()+geom_sf(data=DataTotal, aes(fill = X3))+
  coord_sf()

p2 <- p2 +ggspatial::annotation_scale(
  location = "tl",
  bar_cols = c("grey60", "white")
) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )+
  xlab("Longitude")+
  ylab("Latitude")+
  scale_fill_gradientn(colours = c("darkred", "orange",
                                   "yellow"),
                       name = "Prod. index" ,na.value="white",
                       limits=c(0,100))

plot_grid(p1, p2, labels = c('A', 'B'), label_size = 12)
```

## Autoregresión temporal vs espacial

| Aspecto | AR temporal | AR espacial |
|------------------------|------------------------|------------------------|
| Variable dependiente | $y_t$ | $y_i$ |
| Dependencia | Tiempos anteriores: $y_{t-1}, \ldots, y_{1}$ | Vecinos $y_1, \ldots, y_{i-1}, y_{i+1}, \ldots, y_n$ |
| Fórmula básica | $y_t = \sum_{j=1}^p \phi_j y_{t-j} + \epsilon_t$ | $y_i = \rho\sum_{j=1}^n w_{ij}\times y_j + \epsilon_j$ |
| Interpretación | Persistencia temporal | Dependencia entre ubicaciones |
| Parámetros estructurales | Elección de $p$ | Elección de $w_{ij}$ |

## Matriz de pesos $\mathbf{W}$

$$
\mathbf{W}=\begin{pmatrix}
0 & w_{12} & w_{13} & \cdots &w_{1n}\\ 
w_{21} & 0 & w_{23} & \cdots &w_{2n}\\ 
w_{31} & w_{32} & 0 &\cdots &w_{3n}\\ 
\vdots& \vdots & \vdots & \ddots &\vdots\\ 
w_{n1} & w_{n2} & w_{n3} & \cdots &0\\ 
\end{pmatrix}
$$

::: callout-important
## Vecinos

Define qué observaciones son "vecinas". Algunos ejemplos pueden ser:

-   Binaria: \\(w\_{ij} = 1\\) si \\(i\\) y \\(j\\) son vecinos

-   Inversa a distancia: \\(w\_{ij} = 1/d\_{ij}\\)

Normalización: $\sum_{i=1}^n w_{ij}=1$ facilita interpretación de \\(\\rho\\)
:::

## Modelo SAR básico

$$
\mathbf{y} = \rho \pmb{W} \mathbf{y} + \mathbf{X}\boldsymbol{\beta} +\boldsymbol{\epsilon}
$$

Donde $\mathbf{y}$ es el vector $n \times 1$ de las variables dependientes de interés, $\mathbf{X}$ es una matriz $n \times k$ de variables explicativas con coeficientes asociados $\boldsymbol{\beta}$

::: callout-note
## Es un modelo lineal "clásico"

$$ \mathbf{y}-\rho \pmb{W} \mathbf{y}  = \mathbf{X}\boldsymbol{\beta} +\boldsymbol{\epsilon} $$

$$ \mathbf{Ay}  = \mathbf{X}\boldsymbol{\beta} +\boldsymbol{\epsilon} $$

$$ \mathbf{y}  = \mathbf{A}^{-1}\mathbf{X}\boldsymbol{\beta} +\mathbf{A}^{-1}\boldsymbol{\epsilon} $$
:::

::: callout-caution
## Tarea

Demuestra que si $\vert \rho \vert<1$ entonces $\mathbf{A}^{-1}=\sum_{j=0}^\infty \rho^j\mathbf{W}^j$
:::

## Estimación

Para obtener la función de verosimilitud:

-   La varianza de $\mathbf{y}=\sigma^2\mathbf{A}^{-1}(\mathbf{A}^{-1})^\top$

-   El termino $\pmb{\epsilon}= \mathbf{Ay} - \mathbf{X}\boldsymbol{\beta}$ nos permite construir la verosimilitud.

    $$
    L(\pmb{\beta}, \rho, \sigma^2)=(2\pi)^{-\frac{n}{2}}\vert \mathbf{A}\vert\exp\left(-\frac{1}{2}\pmb{\epsilon}^\top\pmb{\epsilon} \right)
    $$

    $$
    \ell(\pmb{\beta}, \rho, \sigma^2)=-\frac{n}{2}\ln(2\pi)+\ln\vert \mathbf{A}\vert-\frac{1}{2}\pmb{\epsilon}^\top\pmb{\epsilon}
    $$

    $$
    \frac{\partial{\ell}}{\partial\boldsymbol{\beta}}=\pmb{\epsilon}^{\top}\mathbf{X}, \; \frac{\partial{\ell}}{\partial\rho}=-\mbox{tr} (\mathbf{A}^{-1} \mathbf{W})+\pmb{\epsilon}^{\top}\mathbf{W} \mathbf{y}
    $$

## Estimación

::: callout-tip
## OLS

$\hat{\pmb{\beta}}$ es un estimador de mínimos cuadrados "ordinarios" si $\rho$ es conocido.

$$
\hat{\boldsymbol{\beta}}=\left(\mathbf{X}^{\top}\mathbf{X}\right)^{-1}\mathbf{X}^{\top}\mathbf{A}\mathbf{y}
$$
:::

::: callout-important
## $\rho$

Para estimar $\rho$ no se tiene una solución exacta, pero se puede obtar por dos metodos:

1.  Scoring Fisher: $\mathcal{I}_{{\rho}{\rho}}=\text{tr}(\mathbf{A}^{-1}\mathbf{W})^2+\text{tr}(\mathbf{W}\mathbf{A} ^{-1})^\top(\mathbf{W}\mathbf{A}^{-1})+(\mathbf{W}\mathbf{A}^{-1}\mathbf{X}\boldsymbol{\beta})(\mathbf{W}\mathbf{A}^{-1}\mathbf{X}\boldsymbol{\beta})$
2.  Máximización directa $\hat{\rho}=\mbox{argmax}_{\rho\in(-1,1)}\left(\ln\vert \mathbf{A}\vert-\frac{1}{2}\pmb{\epsilon}^\top\pmb{\epsilon}\right)$
:::

::: callout-caution
## Tarea

Demuestra $\mathcal{I}_{{\rho}{\rho}}$ está bien calculada, además que es positiva.
:::

## Propiedades de los estimadores

::: callout-note
## MLE

-   Los estimadores obtenidos por máxima verosimilitud son asintoticamente insesgados, consistentes y normales su los supuestos son ciertos[@theoryo1998]. [@spatialreg]

-   Sí el supuesto de normalidad no se cumple, [@lee2004] demuestra que aún siguen siendo normales, pero su varianza asintotica cambia.

-   Sí el supuesto de homocedasticidad no se cumple, [@kelejian2010] encuentra un estimador robusto con mejor desempeño que el OLS usual. [@sphet]

-   Sí se quiere modelar la varianza, [@toloza-delgado2025] permite estimar los componentes de varianza. [@spatemR]
:::

```{r, echo=TRUE}
library(spatialreg)
library(sphet)
library(spatemR)
```

::: callout-caution
Sí la linealidad no se cumple, "habemus problemas"
:::

## Índice de GINI en Colombia

::: callout-warning
## Test de Moran

¿Existe correlación entre el índice de Gini de los municipios de Colombia? El índice de Moran se define como:

$$
I = \frac{n}{W_0 = \sum_{i=1}^n \sum_{j=1}^n w_{ij}} \frac{\sum_{i=1}^n \sum_{j=1}^n w_{ij}(y_i-\bar{y})(y_j-\bar{y})}{\sum_{i=1}^n (y_i-\bar{y})^2}
$$
:::

```{r, echo=TRUE, eval=FALSE}
cont.nb <- poly2nb(DataComplete) 	
wt1 <- nb2mat(cont.nb, zero.policy = TRUE)
cont.listw <- nb2listw(cont.nb, style="W",zero.policy=T)
moran.test(DataComplete$GINI, cont.listw)
```

```{r}
load("Clase.RData")
moran.test(DataComplete$GINI, cont.listw)
```

## I de Moran

```{r}
moran.plot(DataComplete$GINI, cont.listw,ylab="Índice de Gini rezagado espacialmente",xlab="Índice de Gini",labels = F)
```

## Modelo SAR

::: callout-tip
$\mathbf{X}$: $X_1$: un índice asociado al uso adecuado del suelo rural, $X_2$: un índice de competitividad, $X_3$: un índice de productividad, $X_4$: el índice de fortaleza institucional, y $X_5$: la tasa de homicidios por cada 100.000 habitantes.
:::

```{r, echo=TRUE}
HomSARAR <- lagsarlm(GINI~X1+X2+X3+X4+X5,
                     data=DataComplete,
                     listw =cont.listw,
                     zero.policy = T, )
summary(HomSARAR)
```

## Siguiente clase

-   Análisis de los coeficientes de cada covariable $X_j$.

-   Criterios de diagnóstico del modelo, residuales y AIC.

-   Predicción de valores fuera de la muestra.

-   Estimación robusta de $\rho$ con la metodología de @kelejian2010.

# Bloque 2: Plan Docente

::: callout-note
## Curso

Modelos Estadísticos y de Aprendizaje Automático para datos Espacio-Temporales
:::

::: callout-tip
## Introducción

-   Qué es autocorrelación: valores cercanos tienden a ser similares
-   Tipos:
    -   Temporal: series de precios, temperatura diaria
    -   Espacial: deforestación, crimen por vecindario
    -   Espacio temporal: Combinación de las anteriores.
-   Importancia en análisis de datos georreferenciados. Manejo de mapas en R, Python y GIS.
:::

## Modelos estadísticos

::: callout-important
## Espaciales

-   Estructuras de autocorrelación espacial.
-   Modelos SAR y SEM: capturan dependencia entre ubicaciones
-   Concepto de matriz de pesos espaciales (W)
-   Interpretación: impactos directos e indirectos
-   Aplicaciones: predicción de fenómenos geográficos y socioeconómicos
:::

::: callout-warning
## Temporales (Recordatorio de Series de Tiempo)

-   Autoregresión temporal: persistencia en el tiempo. AR, MA, ARMA y extensiones
-   Estructuras de autocorrelación temporal, ACF y PACF.
:::

## Modelos estadísticos

::: callout-tip
## Espacio-temporales

-   Correlación espacial, regularización, validación espacial y temporal
-   **SARAR temporal:** captura dependencia tanto en variable dependiente como en perturbaciones a través del tiempo y espacio
-   **SAR heterocedástico para datos de panel:** maneja varianza no constante en observaciones espaciales y temporales
-   **GEE espaciales y semiparamétricos:** para estructuras de correlación complejas
:::

## Machine Learning

::: callout-tip
-   **Métodos clásicos adaptados:**
    -   **Random Forest espacio-temporal:** incorpora covariables espaciales y dependencias temporales
-   **Avances en redes neuronales:**
    -   **Convolutional LSTM y CNN para datos georreferenciados:** integran información espacial y temporal
    -   **Spatio-Temporal Deep Learning:** combina redes recurrentes y convolucionales para predicción de series geoespaciales
:::

## Evaluación del curso

::: callout-important
## Evaluaciones presenciales

-   **Prueba 1 (20%)**
    -   Evaluación computacional sobre conceptos básicos espaciales y temporales
    -   Resolución de ejercicios con R o Python
-   **Prueba 2 (20%)**
    -   Evaluación computacional sobre modelos espacio-temporales y ML
    -   Interpretación de resultados y análisis de impactos
:::

::: callout-tip
## Proyecto

-   **Proyecto final (60%)**
    -   Aplicación práctica a un dataset real.
    -   Lectura de artículos científicos en el área
    -   Combinar teoría de modelos clásicos con métodos de ML
    -   Análisis reproducible, predicciones y visualización (mapas de riesgo)
:::

## Bibliografía clave

-   Anselin, L. (1988). *Spatial Econometrics: Methods and Models.*
-   Cressie, N. (1993). *Statistics for Spatial Data.*
-   Hastie, T., Tibshirani, R., & Friedman, J. (2009). *The Elements of Statistical Learning.*
-   Guignard, F. (2022). *On Spatio-Temporal Data Modelling and Uncertainty Quantification Using Machine Learning and Information Theory*.
-   Wickle, C. & Zammit-Mangion, A. (2023) *Statistical Deep Learning for Spatial and Spatiotemporal Data*

## Formación básica

::: callout-note
## Fundamentación

-   **Básica y transversal**: Estadística descriptiva, probabilidad para ingeniería, ciencias y sociales.

-   **Fundamentos teóricos**: Probabilidad y estadística en pregrado de estadística y matemáticas.

-   **Estadística teórica y aplicada**: Análisis estadístico de datos espaciotemporales

-   **Enfoque pedagógico**: Rigor teórico + aplicaciones prácticas; metodologías activas y proyectos interdisciplinarios.
:::

::: callout-tip
## Soporte

-   He dictado clases en diferentes programas de pregrado en la **Universidad Nacional de Colombia**, la **Universitat de les Illes Balears** y otras instituciones, fortaleciendo tanto la formación básica como la avanzada en estadística.
-   He acompañado la **dirección de trabajos de grado** en áreas de matemáticas, estadística e ingeniería
:::

## Áreas avanzadas

::: callout-note
## Estadística avanzada

-   **Diseño experimental** para programas de estadística y áreas afines (agronomía, biología, ingeniería).

-   **Estadística experimental y validación de escalas** en maestría y especialización, con aplicaciones a problemáticas nacionales como Tuberculosis, seguridad y salud en el trabajo y enfermedades de transmisión sexual.

-   **Aprendizaje de máquina y modelado en la nube**, orientado a grandes volúmenes de datos y procesos de predicción.

-   Énfasis en el **desarrollo de competencias analíticas sólidas**, combinando teoría rigurosa con aplicaciones prácticas e interdisciplinarias.
:::

::: callout-tip
## Soporte

-   He dictado cursos en **diversas maestrías** y programas de posgrado en estadística y áreas afines.

-   He impartido formación especializada para **corporaciones bancarias** y otras instituciones del sector productivo.

-   He trabajado como **consultor en el ICFES, en CALA y en otras entidades nacionales e internacionales**.
:::

## Recursos didácticos

-   Material actualizado y libre acceso. Plataformas digitales (GitHub) con códigos y ejemplos.

    -   [Estadística para Farmacia](https://cruzalirio.github.io/Farmacia/)
    -   [Aprendizaje de Máquina](https://madcentral.github.io/metodosestadisticos/)
    -   [Estadística para Enfermería](https://github.com/Cruzalirio/Unal-Enfermeria-/tree/main)
    -   [Aprendizaje de máquina](https://drive.google.com/drive/folders/1D2fYj_BEuGXC8m6qQNe56El5H6fx53i5?usp=sharing)
    -   [Fundamentos de Estadística](https://drive.google.com/drive/folders/13pES47M5AGwdI2FzZL6GHYe5mmL-8yfn?usp=sharing)

    ::: callout-tip
    -   **Uso intensivo de software estadístico** para análisis reproducible y aprendizaje práctico.

    -   **Resolución de problemas reales**, aplicando estadística a situaciones concretas de distintas disciplinas.

    -   **Fomento de la interdisciplinariedad e innovación**, promoviendo proyectos que integren teoría, datos y aplicación.
    :::

## Adicionalmente

::: callout-important
-   Coordiné durante un año la **Maestría en Analítica de Datos de la Universidad Central**, siendo **uno de sus creadores**.

-   He **asesorado varias tesis** en la Universidad como **estadístico**, apoyando investigación académica en distintas áreas.

-   **Competencia multilingüe**, lo que permite enseñar a estudiantes de distintos países o en programas internacionales.

-   **Flexibilidad docente**, adaptando contenidos y ejemplos según el idioma y contexto cultural.

-   **Mayor alcance y visibilidad académica**, especialmente para cursos de posgrado o colaboraciones internacionales.

-   He dirigido **tesis de maestría en áreas diversas** articulando investigación académica con problemáticas reales.
:::

# Bloque 2: Plan Investigativo

## Tema y contexto

-   Tema: Modelación espacio-temporal de la deforestación municipal en Colombia

-   Enfoque: Estadístico robusto, econometría espacial y GAMLSS

-   Contexto: fenómeno multicausal, necesidad de análisis a nivel municipal

    ::: callout-tip
    ## Avances

    -   Trabajo teórico avanzado con articulos publicados y preprints en el área. @toloza-delgado2025, @azcarate-romero2025

    -   Software Estadístico, con un paquete en R: [spatemR](https://cran.r-project.org/web/packages/spatemR/index.html)

    -   Un preprint con pronóstico de datos faltantes espaciales @tobar2025.
    :::

## Preguntas de investigación

::: callout-note
-   ¿Cómo se distribuye espacial y temporalmente la deforestación?

-   ¿Qué factores socioeconómicos e institucionales la explican?

-   ¿Qué tan efectivos son los modelos clásicos frente a GSAR/GAMLSS?

-   ¿Cómo manejar heterocedasticidad, no normalidad y correlación espacio-temporal?
:::

::: callout-tip
## Avances

-   Un preprint de estadística espacio temporal en revisión @cruz2025.

-   Una tesis de maestría dirigida sobre el tema en la Universidad Central, ***Desarrollo de un modelo predictivo con técnicas de inteligencia artificial que permita la identificación de municipios en riesgo de deforestación mediante la incorporación de variables socioeconómicas espaciales.***
:::

## Objetivo general

::: callout-note
## Objetivo

Desarrollar e implementar **modelos estadísticos espacio-temporales robustos** que permitan **evaluar, explicar y predecir la deforestación municipal** en Colombia, integrando metodologías avanzadas de econometría espacial y modelamiento estadístico.
:::

1.  Integración de fuentes de datos:
    -   Cobertura boscosa anual (IDEAM), Factores de presión: agroindustria, cultivos ilícitos, vías
    -   Variables socioeconómicas: población rural, minería, conflictos, Información climática y presupuestal (CHIRPS, DANE, SECOP)
2.  Modelamiento espacio-temporal:
    -   SAR y SEM clásicos, SAR heterocedástico (GAMLSS)
    -   GSAR para conteos y proporciones no normales, Modelos semiparamétricos tipo GEE

## Validación, resultados y plan de trabajo

-   Validación cruzada espacial y comparación de escenarios
-   Resultados esperados:
    -   Mapas de riesgo municipal
    -   Predicciones con incertidumbre
    -   Paquete en R y publicaciones científicas
-   Plan de trabajo anual:
    -   Año 1: Recolección y análisis de datos
    -   Año 2: Desarrollo de modelos y validación
    -   Año 3: Difusión, mapas de riesgo y transferencia tecnológica
-   Pertinencia institucional: integración docencia-investigación y fortalecimiento de estadística aplicada

# Bloque 3: Proyección misional

## Contribución a los fines misionales

-   **Contribuir a la unidad nacional y su vinculación internacional**
    -   Mis proyectos sobre deforestación municipal generan conocimiento que puede ser aplicado en políticas públicas nacionales e integrarse en redes internacionales de investigación ambiental.
-   **Crear y asimilar críticamente el conocimiento**
    -   Desarrollo de modelos SAR, GAMLSS y GSAR para análisis espacial avanzado, generando nuevo conocimiento metodológico aplicable a problemas reales de Colombia.

## Contribución a los fines misionales

-   **Formar profesionales e investigadores con conciencia crítica**
    -   Integración de teoría estadística, programación y análisis reproducible en pregrado y posgrado.
    -   Preparación de estudiantes para liderar investigaciones y proyectos de política ambiental.
-   **Estudiar y enriquecer el patrimonio natural y contribuir a su conservación (Apoyo a la sociedad y al Estado)**
    -   Análisis espacial de deforestación que permite identificar zonas críticas y generar mapas de riesgo para la toma de decisiones ambientales.

## Contribución a los fines misionales

-   **Propender por el desarrollo personal y académico de la comunidad**
    -   Uso de metodologías activas, software libre y recursos abiertos para fortalecer capacidades analíticas y de investigación en estudiantes.
    -   Generación de herramientas estadísticas y mapas de riesgo que sirven para asesoría en políticas públicas y toma de decisiones en gestión ambiental.
-   **Fomentar la interdisciplinariedad y la cooperación**
    -   Vinculación de estudiantes y grupos de investigación con proyectos interinstitucionales y redes académicas internacionales en estadística aplicada y medio ambiente.

## Bibliografía
